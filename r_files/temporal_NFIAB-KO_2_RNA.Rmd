---
title: "RNA_3_NFIAB_KO"
output: github_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

# RNA analysis
Differential gene exp in groups of samples: genes changing over time, and defects in NIFA/B KO. 

Generate the comparison and export the data. 

Start the analysis in the next script by importing these data so it is more efficient. 

```{r message=FALSE}

rm(list=ls())

library(DESeq2)
library(RColorBrewer)
library(tidyverse)
library(ComplexHeatmap)
library(tximport)

```


### Set dirs
```{r}

workingdir="~/Dropbox (The Francis Crick)/Glial_cisReg/"
outdir="outputs_glialRNA_3_NFIAB_KO/"
subworkinput="inputs_glialRNA_1_qc/"
ifelse(!dir.exists(file.path(workingdir,outdir)), dir.create(file.path(workingdir,outdir)), "Directory exists")

suboutdir1="output_WT_KO_D7_D11/"
ifelse(!dir.exists(file.path(workingdir,outdir,suboutdir1)), dir.create(file.path(workingdir,outdir,suboutdir1)), "Directory exists")


```



## Load data

For RNA analysis, we are using the output of star_salmon so the import to deseq is a bit more complicated.

```{r }

#salmon counts from pipeline, import
path_files =  list.files(paste0(workingdir,subworkinput)) 
samples = data.frame(run=path_files, stringsAsFactors = FALSE) %>%
  filter(str_detect(run, "MUT|WT"))

files <- file.path(paste0(workingdir,subworkinput), samples$run, "quant.sf")
names(files) <- samples$run
all(file.exists(files))

#from pipeline
tx2gene = read_tsv(paste0(paste0(workingdir,subworkinput),"/salmon_tx2gene.tsv"))

txi.salmon <- tximport(files, type = "salmon", tx2gene = tx2gene)

```



## Colors and shapes

```{r }
sorted.DayGate <- c("D5_p1","D5_p2","D5_pM",
                    "D7_p1","D7_p2","D7_pM",
                    "D9_p1","D9_p2","D9_pM",
                    "D11_p1","D11_p2","D11_pM")
sorted.day <- c("D5","D7","D9","D11")
sorted.dayNfia <- c("D5_NFIAn_WT","D5_NFIAn_MUT",
                    "D7_NFIAn_WT","D7_NFIAn_MUT",
                    "D9_NFIAn_WT","D9_NFIAp_WT","D9_NFIAn_MUT",
                    "D11_NFIAp_WT","D11_NFIAn_MUT")

colorIZ <- c("#abdff4","#f1df9a","#f19aac",
             "#55bee8","#e6c444","#e64466",
            "#1a91c1","#c19e1a","#c11a3d",
            "#0e506b","#6b570e","#7c1127")
  
# 
# # for Days
# red_colors <- c("#fadede","#f3aaaa","#e96666","#cf1e1e")
# 
# # for SAG
# grey_colors <- c("#f6f6f6","#cecece","#808080","#595959")

```

## Differential analysis between WT and KO for each domain at two timepoints

Targeted diff analysis in subsets of samples:

Just for D7 and D11:
WT vs KO: pairwise for p1, p2, pMN
WT vs KO: pairwise for p1, p2, pMN

This DESeq2 analysis is done by subsetting samples. I subset the `txi.salmon$counts` table and then use ` DESeqDataSetFromMatrix` with `round(sub_counts)` to perform the differential analysis. 

```{r diff-KO-WT, message=FALSE, warnings=FALSE}

count_table <- txi.salmon$counts

count_matrix <- count_table %>%
  as.data.frame() %>%
  rownames_to_column("GeneID") %>%
  filter(!str_starts(GeneID, "ERCC")) %>%
  column_to_rownames("GeneID")

#subset 
timepoint=c("_D7_","_D11_")
#subset 
allgates=c("_p2_","_pM_","_p1_")

#no filtering based on genotype

comparisons <- allgates



PairWiseDEseq <- lapply(c(1:length(timepoint)),function (x) {
  lapply(c(1:length(allgates)), function (y) {
      timepoints <- timepoint[x]
      celltypes <- allgates[y]
      sub_counts <- count_matrix %>%
        dplyr::select(contains(celltypes) & contains(timepoints))
      
      ## Make metadata file for DESeq
      genecolData_sub <- data.frame(Sample_ID = colnames(sub_counts))
      genecolData_sub <- genecolData_sub %>% 
        separate(Sample_ID,into=c("Genotype","Day","Gate","NFIAgate","Rep"), sep="_", remove=FALSE) %>%
        mutate(Condition=paste(Genotype,Day,Gate,NFIAgate, sep="_"),
         DayNFIA=paste(Day,NFIAgate,Genotype,sep = "_"),
         DayGate=paste(Day,Gate,sep="_"),
         Experiment=paste(Genotype,Rep,sep="_"),
         NFIAstatus=paste(NFIAgate,Genotype,sep="_"))
      genecolData_sub <- as.data.frame(unclass(genecolData_sub))
      
      dds_sub <- DESeqDataSetFromMatrix(countData =  round(sub_counts),
                                    colData = genecolData_sub,
                                    design = ~ Genotype)
      
      dds_sub <- DESeq(dds_sub)
      
      vsd_sub <- varianceStabilizingTransformation(dds_sub,blind = FALSE)
      
      # Export normalized tables for plotting elsewhere
      dds_sub_counts <- counts(dds_sub, normalized = TRUE)
      vsd_sub_data <- assay(vsd_sub)
      
      results_sub <- results(dds_sub)

      # plotMA(results_sub,ylim=c(-8,8))

      ## Export files
      
      write.table(dds_sub_counts,
      file = paste0(workingdir,outdir,suboutdir1,"CountsNormalized_",resultsNames(dds_sub)[2],timepoints,celltypes,".txt"),
          quote = FALSE, row.names = TRUE)
      write.csv(vsd_sub_data,
          paste0(workingdir,outdir,suboutdir1,"VSData_",resultsNames(dds_sub)[2],timepoints,celltypes,".csv"),
          quote = FALSE)
      write.table(results_sub,
          file = paste0(workingdir,outdir,suboutdir1,"Results_DESeq__",resultsNames(dds_sub)[2],timepoints,celltypes,".txt"),
          quote = FALSE, row.names = TRUE)

      results_return <- results_sub %>% as.data.frame() %>% rownames_to_column("Geneid")
      results_return$Comparison <- paste0("Comp_",resultsNames(dds_sub)[2],timepoints,celltypes)
      results_return

  })
}) 


```





```{r}
sessionInfo()
```